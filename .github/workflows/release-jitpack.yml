name: JitPack Release

permissions:
  contents: write

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        java-version: [8, 11, 17, 21, 24]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK ${{ matrix.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ matrix.java-version }}
        distribution: 'temurin'
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-jdk${{ matrix.java-version }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-jdk${{ matrix.java-version }}-
          ${{ runner.os }}-gradle-
    
    - name: Run tests
      run: ./gradlew test
    
    - name: Build with Gradle
      run: ./gradlew build
    
    - name: Test JitPack publish
      run: ./gradlew publishToMavenLocal
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: matrix.java-version == 8
      with:
        name: jar-artifacts
        path: |
          */build/libs/*.jar
          !*/build/libs/*-sources.jar
          !*/build/libs/*-javadoc.jar

  jitpack-compatibility:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 8
      uses: actions/setup-java@v4
      with:
        java-version: 8
        distribution: 'temurin'
    
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-build-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    - name: Test JitPack build simulation
      run: |
        chmod +x gradlew
        ./gradlew clean
        ./gradlew publishToMavenLocal
        echo "JitPack compatibility verified"

  release:
    runs-on: ubuntu-latest
    needs: [test, jitpack-compatibility]
    
    steps:
      - name: Check deploy token
        run: |
          if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
            echo "DEPLOY_TOKEN is not set. Skipping release."
            exit 1
          fi
          echo "DEPLOY_TOKEN is available. Proceeding with release."

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-release-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Final build for release
        run: ./gradlew build

      - name: Generate version tag
        id: version
        run: |
          VERSION="v0.1.0-$(date +%Y%m%d-%H%M%S)"
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated tag: $VERSION"

      - name: Create and push tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          echo "Creating release tag: $TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "$TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release ${{ steps.version.outputs.tag }}"
          body: |
            üöÄ ÏûêÎèô ÏÉùÏÑ± Î¶¥Î¶¨Ïä§: ${{ steps.version.outputs.tag }}
            
            ## JitPack ÏÇ¨Ïö©Î≤ï
            
            ### Gradle
            ```gradle
            repositories {
                maven { url 'https://jitpack.io' }
            }
            
            dependencies {
                implementation 'com.github.hj4645:commit-chronicle:${{ steps.version.outputs.tag }}'
            }
            ```
            
            ### Maven
            ```xml
            <repositories>
                <repository>
                    <id>jitpack.io</id>
                    <url>https://jitpack.io</url>
                </repository>
            </repositories>
            
            <dependencies>
                <dependency>
                    <groupId>com.github.hj4645</groupId>
                    <artifactId>commit-chronicle</artifactId>
                    <version>${{ steps.version.outputs.tag }}</version>
                </dependency>
            </dependencies>
            ```
            
            ## CLI ÏÇ¨Ïö©Î≤ï
            ```bash
            # alias ÏÑ§Ï†ï
            alias cch="java -jar ~/.gradle/caches/modules-2/files-2.1/com.github.hj4645/commit-chronicle/${{ steps.version.outputs.tag }}/*/commitchronicle-0.1.0.jar"
            
            # ÏÇ¨Ïö©
            cch summarize
            cch pr
            cch settings
            ```
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }} 